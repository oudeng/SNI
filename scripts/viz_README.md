# Visualization Scripts for SNI Reproducibility

This document describes **additional visualization commands** to run **after completing all experiments in `readme_CL.txt`**. These scripts generate publication-ready figures from the aggregated experiment results.

> **Note**: The commands in `readme_CL.txt` already generate per-experiment outputs (heatmaps, metrics, dependency matrices). This document covers cross-experiment visualizations and paper-ready figures.

---

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Output Directory Convention](#2-output-directory-convention)
3. [Workflow Overview](#3-workflow-overview)
4. [Step-by-Step Commands](#4-step-by-step-commands)
5. [Scripts Reference](#5-scripts-reference)
6. [Output Formats](#6-output-formats)
7. [Color Palette](#7-color-palette)

---

## 1. Prerequisites

Before running these visualization scripts, ensure you have completed the following from `readme_CL.txt`:

| Experiment | Required Output | Section in readme_CL.txt |
|------------|-----------------|--------------------------|
| SNI Main | `results_sni_main/_summary/summary_agg.csv` | PART 1.1 |
| SNI Ablation | `results_sni_ablation/_summary/summary_agg.csv` | PART 1.2 |
| SNI MNAR | `results_sni_mnar/_summary/summary_agg.csv` | PART 1.3 |
| Baselines Main | `results_baselines_main/_summary/summary_agg.csv` | PART 2.1 |
| Baselines MNAR | `results_baselines_mnar/_summary/summary_agg.csv` | PART 2.2 |
| Baselines Deep | `results_baselines_deep/_summary/summary_agg.csv` | PART 2.3 |
| Sanity Check | `results_sanity_s5/table_S21.csv` | PART 3 |

Verify prerequisites:

```bash
# Check all required summary files exist
for f in results_sni_main/_summary/summary_agg.csv \
         results_sni_ablation/_summary/summary_agg.csv \
         results_sni_mnar/_summary/summary_agg.csv \
         results_baselines_main/_summary/summary_agg.csv \
         results_baselines_mnar/_summary/summary_agg.csv \
         results_baselines_deep/_summary/summary_agg.csv; do
    if [ -f "$f" ]; then echo "[OK] $f"; else echo "[MISSING] $f"; fi
done
```

---

## 2. Output Directory Convention

To avoid overwriting files generated by `readme_CL.txt`, all visualization outputs go to the `figs/` directory:

```
figs/
├── merged/                    # Merged summary CSV files
│   ├── merged_main.csv        # SNI + Baselines (main experiments)
│   ├── merged_mnar.csv        # SNI + Baselines (MNAR experiments)
│   └── merged_all.csv         # All experiments combined
├── paper_figures/             # Main-text figures
│   ├── Fig_RateSweep_*.{png,pdf}
│   ├── Fig_Pareto_*.{png,pdf}
│   └── Fig_Robustness_*.{png,pdf}
├── supplementary/             # Supplementary figures
│   ├── heatmap_*.{png,pdf}
│   ├── dependency_network_*.{png,pdf}
│   └── ...
└── comprehensive/             # Full figure sets from viz_make_figures.py
    ├── main/
    ├── ablation/
    └── mnar/
```

---

## 3. Workflow Overview

```
┌─────────────────────────────────────────────────────────────────┐
│ readme_CL.txt completes → summary_agg.csv files available       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: Merge results → figs/merged/merged_*.csv                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: Generate comprehensive figures → figs/comprehensive/    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: Generate paper figures → figs/paper_figures/            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: Generate supplementary figures → figs/supplementary/    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Step-by-Step Commands

### Step 1: Create Merged Summary Files

```bash
mkdir -p figs/merged

# Merge SNI + Baselines (Main: MCAR/MAR @ 30%)
python scripts/viz_make_figures.py \
    --summary-csv results_sni_main/_summary/summary_agg.csv \
    --summary-csv results_baselines_main/_summary/summary_agg.csv \
    --summary-csv results_baselines_deep/_summary/summary_agg.csv \
    --outdir figs/merged \
    --write-merged \
    --mechanisms MCAR,MAR \
    --rates 30per

mv figs/merged/merged_summary_agg.csv figs/merged/merged_main.csv

# Merge SNI + Baselines (MNAR: all rates)
python scripts/viz_make_figures.py \
    --summary-csv results_sni_mnar/_summary/summary_agg.csv \
    --summary-csv results_baselines_mnar/_summary/summary_agg.csv \
    --outdir figs/merged \
    --write-merged \
    --mechanisms MNAR

mv figs/merged/merged_summary_agg.csv figs/merged/merged_mnar.csv

# Merge ALL experiments
python scripts/viz_make_figures.py \
    --summary-csv results_sni_main/_summary/summary_agg.csv \
    --summary-csv results_sni_mnar/_summary/summary_agg.csv \
    --summary-csv results_baselines_main/_summary/summary_agg.csv \
    --summary-csv results_baselines_mnar/_summary/summary_agg.csv \
    --summary-csv results_baselines_deep/_summary/summary_agg.csv \
    --outdir figs/merged \
    --write-merged

mv figs/merged/merged_summary_agg.csv figs/merged/merged_all.csv
```

### Step 2: Generate Comprehensive Figures

```bash
# Main experiments (SNI + Baselines, MCAR/MAR @ 30%)
python scripts/viz_make_figures.py \
    --summary-csv figs/merged/merged_main.csv \
    --outdir figs/comprehensive/main \
    --mechanisms MCAR,MAR \
    --rates 30per \
    --top-k 10 \
    --dpi 600

# Ablation study (SNI variants only)
python scripts/viz_make_figures.py \
    --summary-csv results_sni_ablation/_summary/summary_agg.csv \
    --outdir figs/comprehensive/ablation \
    --dpi 600

# MNAR experiments
python scripts/viz_make_figures.py \
    --summary-csv figs/merged/merged_mnar.csv \
    --outdir figs/comprehensive/mnar \
    --mechanisms MNAR \
    --dpi 600
```

### Step 3: Generate Main-Text Paper Figures

```bash
mkdir -p figs/paper_figures

# Figure: Accuracy-Runtime Trade-off (Pareto front)
python scripts/viz_pareto_accuracy_runtime.py \
    --csv figs/merged/merged_main.csv \
    --rate 30per \
    --mechanisms MCAR MAR \
    --outdir figs/paper_figures \
    --outfile Fig_Pareto_AccuracyRuntime \
    --dpi 600

# Figure: Mechanism Robustness (MCAR vs MAR delta)
python scripts/viz_mcar_mar_robustness.py \
    --csv figs/merged/merged_main.csv \
    --rate 30per \
    --outdir figs/paper_figures \
    --outfile Fig_MCARvsMAR_Robustness \
    --dpi 600
```

### Step 4: Generate Supplementary Figures

```bash
mkdir -p figs/supplementary

# Dependency network visualization (representative dataset: MIMIC)
python scripts/viz_dependency_network.py \
    --dependency-matrix results_sni_main/MIMIC_MAR_30per_seed8/dependency_matrix.csv \
    --tau 0.15 \
    --outdir figs/supplementary \
    --dpi 600

# Dependency network for other datasets (optional)
for dataset in NHANES eICU Concrete; do
    python scripts/viz_dependency_network.py \
        --dependency-matrix results_sni_main/${dataset}_MAR_30per_seed8/dependency_matrix.csv \
        --tau 0.15 \
        --outdir figs/supplementary \
        --dpi 600
done
```

---

## 5. Scripts Reference

### 5.1 `viz_make_figures.py`

**Purpose**: Comprehensive figure generation from summary_agg.csv files. Produces heatmaps, bar charts, rate curves, and runtime scatter plots.

**Key Arguments**:

| Argument | Description | Default |
|----------|-------------|---------|
| `--summary-csv` | Path to summary_agg.csv (repeatable) | Required |
| `--summary-dir` | Directory containing summary_agg.csv (repeatable) | - |
| `--outdir` | Output directory | Required |
| `--mechanisms` | Comma-separated: MCAR,MAR,MNAR | All |
| `--rates` | Comma-separated: 10per,30per,50per | All |
| `--top-k` | Top-K algorithms for charts | 12 |
| `--write-merged` | Save merged CSV | False |
| `--dpi` | Output resolution | 600 |

**Outputs**:
- `heatmap_<metric>_<mechanism>_<rate>.{png,pdf}`
- `overall_bar_<metric>.{png,pdf}`
- `taskbar_<dataset>_<mechanism>_<rate>_<metric>.{png,pdf}`
- `curve_<dataset>_<mechanism>_<metric>.{png,pdf}`
- `scatter_runtime_vs_nrmse.{png,pdf}`
- `merged_summary_agg.csv` (if `--write-merged`)

---

### 5.2 `viz_pareto_accuracy_runtime.py`

**Purpose**: Accuracy-runtime trade-off figure with Pareto front highlighting.

**Key Arguments**:

| Argument | Description | Default |
|----------|-------------|---------|
| `--csv` | Path to CSV (repeatable) | Required |
| `--rate` | Missing rate filter | `30per` |
| `--mechanisms` | Space-separated mechanisms | `MCAR MAR` |
| `--outdir` | Output directory | `figs` |
| `--outfile` | Output filename (no extension) | `Fig_Pareto_AccuracyRuntime` |
| `--logx` | Log scale for x-axis | True |
| `--dpi` | Resolution | 600 |

**Output Panels**:
- (A) NRMSE vs Runtime
- (B) Macro-F1 vs Runtime

---

### 5.3 `viz_mcar_mar_robustness.py`

**Purpose**: Mechanism robustness comparison showing |Δ| between MCAR and MAR.

**Key Arguments**:

| Argument | Description | Default |
|----------|-------------|---------|
| `--csv` | Path to CSV (repeatable) | Required |
| `--rate` | Missing rate to analyze | `30per` |
| `--outdir` | Output directory | `figs` |
| `--outfile` | Output filename | `Fig_MCARvsMAR_Robustness` |
| `--dpi` | Resolution | 600 |

**Output Panels**:
- (A) |Δ| NRMSE (continuous)
- (B) |Δ| Macro-F1 (categorical)

---

### 5.4 `viz_dependency_network.py`

**Purpose**: Visualize learned dependency matrix as a directed network graph.

**Key Arguments**:

| Argument | Description | Default |
|----------|-------------|---------|
| `--dependency-matrix` | Path to dependency_matrix.csv | Required |
| `--tau` | Edge threshold (show edges > τ) | 0.15 |
| `--outdir` | Output directory | Required |
| `--dpi` | Resolution | 600 |

**Output**: `dependency_network.{png,pdf}`

---

### 5.5 `viz_compact_rate_sweep.py`

**Purpose**: Compact 2-panel figure (MCAR + MAR) showing missing-rate sensitivity.

> **Note**: This script requires rate-sweep experiment results. If you ran the optional rate-sweep experiments (PART 5.1 in readme_CL.txt), use:

```bash
python scripts/viz_compact_rate_sweep.py \
    --csv results_sni_rate_sweep/_summary/summary_agg.csv \
    --metric cont_NRMSE_mean \
    --algos SNI MissForest \
    --rates 10per 30per 50per \
    --mechanisms MCAR MAR \
    --outdir figs/paper_figures \
    --outfile Fig_RateSweep_NRMSE \
    --dpi 600
```

**Key Arguments**:

| Argument | Description | Default |
|----------|-------------|---------|
| `--csv` | Path to CSV (repeatable) | Required |
| `--metric` | Metric to plot | `cont_NRMSE_mean` |
| `--algos` | Space-separated algorithms | `SNI MissForest` |
| `--mechanisms` | Panels | `MCAR MAR` |
| `--rates` | X-axis values | `10per 30per 50per` |
| `--outdir` | Output directory | `figs` |
| `--outfile` | Output filename | `Fig_RateSweep` |
| `--dpi` | Resolution | 600 |

---

### 5.6 `viz_rate_sweep.py`

**Purpose**: Single missing-rate sweep figure for detailed analysis.

> **Note**: Requires rate-sweep experiment results (optional PART 5 in readme_CL.txt).

```bash
python scripts/viz_rate_sweep.py \
    --summary-csv results_sni_rate_sweep/_summary/summary_agg.csv \
    --outdir figs/paper_figures \
    --mechanism MAR \
    --metric cont_NRMSE_mean \
    --algos SNI,MissForest \
    --outfile rate_sweep_mar_nrmse \
    --dpi 600
```

---

## 6. Output Formats

All scripts generate both vector and raster outputs:

| Format | Resolution | Use Case |
|--------|------------|----------|
| `.pdf` | Vector | Journal submission, print |
| `.png` | 600 DPI | Presentations, web, preprint |

**Recommended Figure Placement**:

| Figure | Placement | Width |
|--------|-----------|-------|
| Pareto trade-off | Main text | 2-column (`figure*`) |
| Mechanism robustness | Main text | 2-column (`figure*`) |
| Rate sweep (compact) | Main text | 1-column or 2-column |
| Heatmaps | Supplementary | 1-column |
| Dependency network | Supplementary | 1-column |

---

## 7. Color Palette

All scripts use a consistent color mapping:

| Algorithm | Color | Hex |
|-----------|-------|-----|
| SNI | Red | `#D62728` |
| MissForest | Green | `#2CA02C` |
| MIWAE | Blue | `#1F77B4` |
| GAIN | Purple | `#9467BD` |
| KNN | Brown | `#8C564B` |
| MICE | Pink | `#E377C2` |
| MeanMode | Gray | `#7F7F7F` |

---

## Quick Reference: Complete Visualization Pipeline

```bash
# After completing readme_CL.txt...

# 1. Create merged files
mkdir -p figs/merged
python scripts/viz_make_figures.py \
    --summary-csv results_sni_main/_summary/summary_agg.csv \
    --summary-csv results_baselines_main/_summary/summary_agg.csv \
    --summary-csv results_baselines_deep/_summary/summary_agg.csv \
    --outdir figs/merged --write-merged --mechanisms MCAR,MAR --rates 30per
mv figs/merged/merged_summary_agg.csv figs/merged/merged_main.csv

# 2. Generate comprehensive figures
python scripts/viz_make_figures.py \
    --summary-csv figs/merged/merged_main.csv \
    --outdir figs/comprehensive/main --dpi 600

# 3. Generate paper figures
mkdir -p figs/paper_figures

python scripts/viz_pareto_accuracy_runtime.py \
    --csv figs/merged/merged_main.csv \
    --outdir figs/paper_figures --outfile Fig_Pareto_AccuracyRuntime

python scripts/viz_mcar_mar_robustness.py \
    --csv figs/merged/merged_main.csv \
    --outdir figs/paper_figures --outfile Fig_MCARvsMAR_Robustness

# 4. Generate supplementary figures
mkdir -p figs/supplementary
python scripts/viz_dependency_network.py \
    --dependency-matrix results_sni_main/MIMIC_MAR_30per_seed8/dependency_matrix.csv \
    --tau 0.15 --outdir figs/supplementary

echo "Visualization complete! Check figs/ directory."
```